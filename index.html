<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Pension Planner">
  <meta name="theme-color" content="#0f0f1a">
  <meta name="description" content="Simple pension planning - find out if you can afford to retire">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <title>Can I Retire? - Pension Planner</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --card: #1a1a2e;
      --card-alt: #16213e;
      --text: #e8e4dc;
      --text-muted: #8b8b9b;
      --primary: #f0c674;
      --success: #2ea043;
      --warning: #e1b12c;
      --danger: #f85149;
      --info: #7eb8da;
      --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Simple centered layout */
    .app { max-width: 800px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header { text-align: center; padding: 40px 20px 30px; }
    .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 8px; }
    .header p { color: var(--text-muted); font-size: 16px; }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text);
    }
    .card h3 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin: 24px 0 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Form elements */
    .field { margin-bottom: 20px; }
    .field label {
      display: block;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
      font-weight: 500;
    }
    .field .hint {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .field input, .field select {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 18px;
      font-weight: 500;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(0,0,0,0.4);
    }
    .field input::placeholder { color: var(--text-muted); }

    /* Input with prefix */
    .input-with-prefix {
      display: flex;
      align-items: stretch;
    }
    .input-prefix {
      background: var(--card-alt);
      border: 1px solid var(--border);
      border-right: none;
      border-radius: 10px 0 0 10px;
      padding: 14px 16px;
      font-size: 18px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
    }
    .input-with-prefix input {
      border-radius: 0 10px 10px 0;
    }

    /* Grid */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media (max-width: 600px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    /* Buttons */
    button {
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--primary) 0%, #e8927c 100%);
      border: none;
      border-radius: 12px;
      color: #1a1a2e;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(240,198,116,0.3); }
    button:active { transform: translateY(0); }
    button.secondary {
      background: var(--card-alt);
      color: var(--text);
      border: 1px solid var(--border);
    }
    button.secondary:hover {
      background: var(--card);
      box-shadow: none;
    }
    button.small { padding: 10px 20px; font-size: 14px; width: auto; }

    /* Result display */
    .result { display: none; }
    .result.visible { display: block; }

    .verdict {
      text-align: center;
      padding: 40px 20px;
      border-radius: 16px;
      margin-bottom: 24px;
    }
    .verdict.success { background: linear-gradient(135deg, rgba(46,160,67,0.15) 0%, rgba(46,160,67,0.05) 100%); border: 2px solid var(--success); }
    .verdict.warning { background: linear-gradient(135deg, rgba(225,177,44,0.15) 0%, rgba(225,177,44,0.05) 100%); border: 2px solid var(--warning); }
    .verdict.danger { background: linear-gradient(135deg, rgba(248,81,73,0.15) 0%, rgba(248,81,73,0.05) 100%); border: 2px solid var(--danger); }

    .verdict-icon { font-size: 64px; margin-bottom: 16px; }
    .verdict h2 { font-size: 28px; margin-bottom: 8px; }
    .verdict.success h2 { color: var(--success); }
    .verdict.warning h2 { color: var(--warning); }
    .verdict.danger h2 { color: var(--danger); }
    .verdict p { color: var(--text-muted); font-size: 16px; max-width: 400px; margin: 0 auto; }

    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
    @media (max-width: 500px) { .stat-grid { grid-template-columns: 1fr; } }

    .stat {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 28px; font-weight: 600; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat.success .stat-value { color: var(--success); }
    .stat.warning .stat-value { color: var(--warning); }
    .stat.danger .stat-value { color: var(--danger); }

    /* Recommendations */
    .recommendation {
      background: rgba(126,184,218,0.1);
      border: 1px solid rgba(126,184,218,0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .recommendation h4 { color: var(--info); margin-bottom: 8px; font-size: 14px; }
    .recommendation p { color: var(--text-muted); font-size: 14px; margin: 0; }

    /* Chart container */
    .chart-container {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }
    .chart-title {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    canvas { width: 100% !important; height: 300px !important; }

    /* Legend */
    .legend { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 12px; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 3px; }

    /* Expandable sections */
    .expand-section { margin-top: 24px; }
    .expand-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      border: 1px solid var(--border);
      transition: background 0.2s;
    }
    .expand-toggle:hover { background: rgba(0,0,0,0.3); }
    .expand-toggle .arrow { transition: transform 0.2s; }
    .expand-toggle.open .arrow { transform: rotate(180deg); }
    .expand-content {
      display: none;
      padding: 20px 0 0;
    }
    .expand-content.open { display: block; }

    /* Navigation tabs */
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .nav-tab {
      padding: 12px 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-tab:hover { background: var(--card-alt); }
    .nav-tab.active {
      background: var(--card-alt);
      color: var(--primary);
      border-color: var(--primary);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Info boxes */
    .info-box {
      background: rgba(126,184,218,0.1);
      border: 1px solid rgba(126,184,218,0.3);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      font-size: 14px;
      color: var(--text-muted);
    }
    .info-box strong { color: var(--info); }

    /* Tables */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--card-alt); color: var(--text-muted); font-size: 12px; text-transform: uppercase; }

    /* Monthly tracker */
    .monthly-entry {
      background: linear-gradient(135deg, var(--card-alt) 0%, var(--card) 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    /* Hidden utility */
    .hidden { display: none !important; }

    /* Slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--card-alt);
      outline: none;
      margin: 12px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .footer a { color: var(--primary); text-decoration: none; }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: rgba(30,30,30,0.95);
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      color: #fff;
      pointer-events: none;
      z-index: 1000;
      max-width: 300px;
      display: none;
    }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <h1>Can I Retire?</h1>
    <p>Find out if your pension savings will last</p>
  </header>

  <!-- Navigation -->
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('check')">Check My Plan</button>
    <button class="nav-tab" onclick="showTab('monthly')">Monthly Tracker</button>
    <button class="nav-tab" onclick="showTab('settings')">Settings</button>
  </div>

  <!-- TAB 1: Check My Plan -->
  <div id="tab-check" class="tab-content active">
    <div class="card">
      <h2>Tell me about your situation</h2>

      <div class="field">
        <label>How much have you saved for retirement?</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="totalSavings" placeholder="500000" value="500000">
        </div>
        <div class="hint">The total in your pension pot (SIPP, workplace pension, etc.)</div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label>How old are you now?</label>
          <input type="number" id="currentAge" placeholder="55" value="55">
        </div>
        <div class="field">
          <label>When do you want to stop working?</label>
          <input type="number" id="retireAge" placeholder="90" value="90">
          <div class="hint">Plan until age (e.g., 90)</div>
        </div>
      </div>

      <div class="field">
        <label>How much do you want per month?</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="monthlyWant" placeholder="2500" value="2500">
        </div>
        <div class="hint">After tax, in your pocket each month</div>
      </div>

      <div class="expand-section">
        <div class="expand-toggle" onclick="toggleExpand(this)">
          <span>Other income sources (State Pension, etc.)</span>
          <span class="arrow">â–¼</span>
        </div>
        <div class="expand-content">
          <div class="grid-2">
            <div class="field">
              <label>State Pension (per year)</label>
              <div class="input-with-prefix">
                <span class="input-prefix">Â£</span>
                <input type="number" id="statePension" placeholder="12000" value="12000">
              </div>
            </div>
            <div class="field">
              <label>State Pension starts at age</label>
              <input type="number" id="statePensionAge" placeholder="67" value="67">
            </div>
          </div>
          <div class="field">
            <label>Other guaranteed income (per year)</label>
            <div class="input-with-prefix">
              <span class="input-prefix">Â£</span>
              <input type="number" id="otherIncome" placeholder="0" value="0">
            </div>
            <div class="hint">e.g., final salary pension, rental income</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 28px;">
        <button onclick="runCheck()">Check My Plan</button>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="result">
      <div id="verdict" class="verdict success">
        <div class="verdict-icon">âœ“</div>
        <h2>You're on track!</h2>
        <p>Based on 1,000 market simulations, your plan has a high chance of success.</p>
      </div>

      <div class="stat-grid">
        <div class="stat success">
          <div class="stat-value" id="successRate">92%</div>
          <div class="stat-label">Chance of Success</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="safeMonthly">Â£2,400</div>
          <div class="stat-label">Safe Monthly Income</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="yearsLast">35+</div>
          <div class="stat-label">Years Your Money Lasts</div>
        </div>
      </div>

      <div id="recommendations"></div>

      <div class="chart-container">
        <div class="chart-title">How your money could grow (or shrink)</div>
        <canvas id="projectionChart"></canvas>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot" style="background: rgba(240,198,116,0.3);"></div> Most likely range</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--primary);"></div> Median outcome</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--danger);"></div> Worst 10%</div>
        </div>
      </div>

      <div class="expand-section">
        <div class="expand-toggle" onclick="toggleExpand(this)">
          <span>Show detailed breakdown</span>
          <span class="arrow">â–¼</span>
        </div>
        <div class="expand-content">
          <div id="detailedStats"></div>
        </div>
      </div>

      <div style="margin-top: 24px; text-align: center;">
        <button class="secondary small" onclick="runCheck()">Run Again</button>
      </div>
    </div>
  </div>

  <!-- TAB 2: Monthly Tracker -->
  <div id="tab-monthly" class="tab-content">
    <div class="card">
      <h2>This Month's Withdrawal</h2>
      <p style="color: var(--text-muted); margin-bottom: 24px;">Enter your current fund values and I'll tell you where to take money from.</p>

      <div class="field">
        <label>Month</label>
        <input type="month" id="entryMonth">
      </div>

      <h3>Your Fund Balances</h3>
      <div class="grid-3">
        <div class="field">
          <label>Stocks/Shares</label>
          <div class="input-with-prefix">
            <span class="input-prefix">Â£</span>
            <input type="number" id="entryStocks" placeholder="250000">
          </div>
        </div>
        <div class="field">
          <label>Bonds</label>
          <div class="input-with-prefix">
            <span class="input-prefix">Â£</span>
            <input type="number" id="entryBonds" placeholder="200000">
          </div>
        </div>
        <div class="field">
          <label>Cash</label>
          <div class="input-with-prefix">
            <span class="input-prefix">Â£</span>
            <input type="number" id="entryCash" placeholder="50000">
          </div>
        </div>
      </div>

      <div style="margin-top: 24px;">
        <button onclick="generateAdvice()">What Should I Do?</button>
      </div>
    </div>

    <div id="monthlyAdvice" class="result">
      <!-- Filled by JS -->
    </div>

    <div class="card">
      <h2>Withdrawal History</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Month</th>
              <th>Withdrawn</th>
              <th>From</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody id="historyTable">
            <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No withdrawals recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 3: Settings -->
  <div id="tab-settings" class="tab-content">
    <div class="card">
      <h2>Your Settings</h2>
      <p style="color: var(--text-muted); margin-bottom: 24px;">These settings are used across all calculations.</p>

      <h3>Income Target</h3>
      <div class="field">
        <label>Target yearly income (before tax)</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="settingsTargetIncome" value="30000">
        </div>
        <div class="hint">The total you want each year from all sources combined</div>
      </div>

      <h3>Fund Targets</h3>
      <div class="info-box">
        <strong>How this works:</strong> Set target amounts for each type of investment. The tool will try to keep at least this much in each fund, drawing from whichever is "over target" first.
      </div>
      <div class="grid-3">
        <div class="field">
          <label>Stocks target</label>
          <div class="input-with-prefix">
            <span class="input-prefix">Â£</span>
            <input type="number" id="settingsStocksMin" value="250000">
          </div>
        </div>
        <div class="field">
          <label>Bonds target</label>
          <div class="input-with-prefix">
            <span class="input-prefix">Â£</span>
            <input type="number" id="settingsBondsMin" value="200000">
          </div>
        </div>
        <div class="field">
          <label>Cash buffer</label>
          <div class="input-with-prefix">
            <span class="input-prefix">Â£</span>
            <input type="number" id="settingsCashTarget" value="50000">
          </div>
        </div>
      </div>

      <h3>Planning Horizon</h3>
      <div class="field">
        <label>Plan for how many years?</label>
        <input type="number" id="settingsDuration" value="35">
        <div class="hint">How long your money needs to last from retirement</div>
      </div>

      <h3>Tax Assumptions</h3>
      <div class="field">
        <label>Will tax thresholds rise with inflation?</label>
        <select id="settingsTaxMode">
          <option value="inflates">Yes - thresholds rise with inflation (optimistic)</option>
          <option value="frozen">No - thresholds stay frozen (pessimistic)</option>
        </select>
        <div class="hint">Frozen thresholds mean you pay more tax over time</div>
      </div>

      <div style="margin-top: 28px;">
        <button onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

    <div class="card">
      <h2>Import / Export Data</h2>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="secondary small" onclick="exportAllData()">Export All Data</button>
        <button class="secondary small" onclick="document.getElementById('importFile').click()">Import Data</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Pension Planner v2.0 | <a href="#" onclick="showTab('settings')">Settings</a></p>
    <p style="margin-top: 8px;">This is not financial advice. Always consult a qualified advisor.</p>
  </footer>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
// ============ HISTORICAL DATA ============
var EQUITY_RETURNS = {1928:0.4781,1929:-0.172,1930:-0.338,1931:-0.527,1932:-0.231,1933:0.669,1934:0.041,1935:0.3879,1936:0.2492,1937:-0.3839,1938:0.2846,1939:-0.0278,1940:-0.1278,1941:-0.1552,1942:0.0782,1943:0.1382,1944:0.1226,1945:0.2665,1946:-0.0818,1947:0.0225,1948:-0.0246,1949:0.1279,1950:0.1787,1951:0.1463,1952:0.0837,1953:-0.0377,1954:0.4399,1955:0.2084,1956:0.0262,1957:-0.1278,1958:0.3396,1959:0.1612,1960:-0.0912,1961:0.1889,1962:-0.1081,1963:0.1715,1964:0.1478,1965:0.1058,1966:-0.1858,1967:0.1506,1968:0.0457,1969:-0.1524,1970:0.0482,1971:0.0627,1972:0.1476,1973:-0.1652,1974:-0.2777,1975:0.3815,1976:0.1774,1977:-0.1271,1978:-0.0303,1979:0.0414,1980:0.1493,1981:-0.0909,1982:0.1976,1983:0.2027,1984:-0.0365,1985:0.2778,1986:0.2278,1987:0.0227,1988:0.1185,1989:0.2697,1990:-0.0456,1991:0.2013,1992:0.0440,1993:0.1372,1994:0.0218,1995:0.3345,1996:0.2601,1997:0.2264,1998:0.1627,1999:0.2516,2000:-0.0617,2001:-0.0727,2002:-0.1679,2003:0.2525,2004:0.0333,2005:-0.0061,2006:0.1618,2007:0.0648,2008:-0.3355,2009:0.1882,2010:0.1102,2011:0.0556,2012:0.0728,2013:0.2665,2014:0.0775,2015:-0.0230,2016:0.1342,2017:0.2511,2018:-0.0583,2019:0.2234,2020:0.0726,2021:0.1873,2022:-0.0878,2023:0.1399,2024:0.1299};
var INFLATION = {1928:-0.012,1929:0.002,1930:-0.060,1931:-0.094,1932:-0.103,1933:0.005,1934:0.021,1935:0.030,1936:0.014,1937:0.028,1938:-0.020,1939:-0.014,1940:0.010,1941:0.099,1942:0.090,1943:0.030,1944:0.023,1945:0.023,1946:0.186,1947:0.087,1948:0.030,1949:-0.020,1950:0.059,1951:0.060,1952:0.009,1953:0.006,1954:-0.007,1955:0.004,1956:0.030,1957:0.028,1958:0.017,1959:0.015,1960:0.014,1961:0.007,1962:0.013,1963:0.017,1964:0.010,1965:0.019,1966:0.034,1967:0.028,1968:0.046,1969:0.062,1970:0.055,1971:0.033,1972:0.034,1973:0.087,1974:0.124,1975:0.069,1976:0.048,1977:0.067,1978:0.090,1979:0.133,1980:0.125,1981:0.089,1982:0.038,1983:0.038,1984:0.040,1985:0.038,1986:0.011,1987:0.044,1988:0.044,1989:0.046,1990:0.061,1991:0.030,1992:0.029,1993:0.027,1994:0.026,1995:0.025,1996:0.034,1997:0.017,1998:0.016,1999:0.027,2000:0.034,2001:0.016,2002:0.024,2003:0.019,2004:0.033,2005:0.034,2006:0.025,2007:0.041,2008:0.001,2009:0.027,2010:0.015,2011:0.030,2012:0.017,2013:0.015,2014:0.008,2015:0.007,2016:0.021,2017:0.021,2018:0.019,2019:0.023,2020:0.012,2021:0.070,2022:0.065,2023:0.032,2024:0.029};

var STORAGE_KEY = 'pension_planner_v2';
var HISTORY_KEY = 'pension_history_v2';

// ============ UTILITIES ============
function seededRng(seed) {
  var s = seed;
  return function() {
    s = Math.sin(s) * 10000;
    return s - Math.floor(s);
  };
}

function gauss(m, std, rng) {
  return Math.sqrt(-2 * Math.log(rng())) * Math.cos(2 * Math.PI * rng()) * std + m;
}

function formatMoney(n) {
  if (n >= 1000000) return 'Â£' + (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return 'Â£' + Math.round(n / 1000) + 'k';
  return 'Â£' + Math.round(n);
}

// ============ TAB NAVIGATION ============
function showTab(tab) {
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  document.querySelector('.nav-tab[onclick*="' + tab + '"]').classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

function toggleExpand(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
}

// ============ STORAGE ============
function getSettings() {
  try {
    var data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (data) return data;
  } catch(e) {}
  return {
    targetIncome: 30000,
    stocksMin: 250000,
    bondsMin: 200000,
    cashTarget: 50000,
    duration: 35,
    taxMode: 'inflates',
    pa: 12570,
    brl: 50270
  };
}

function saveSettingsToStorage(settings) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
}

function getHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  } catch(e) { return []; }
}

function saveHistory(history) {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

// ============ SIMULATION ENGINE ============
function bondReturn(inf, eq, prevInf, rng) {
  var linkerWeight = 0.15, nomBondWeight = 0.30, propertyWeight = 0.20;
  var commodityWeight = 0.10, cashWeight = 0.10, equityWeight = 0.15;

  var laggedInf = prevInf !== undefined ? prevInf : inf;
  if (laggedInf > 0.045) {
    var reactionQuality = rng() > 0.30 ? 1.0 : 0.5;
    linkerWeight = 0.15 + (0.20 * reactionQuality);
    nomBondWeight = 0.30 - (0.10 * reactionQuality);
    equityWeight = 0.15 - (0.05 * reactionQuality);
  }

  var linkerReturn = inf + 0.005 + gauss(0, 0.03, rng);
  var nomBondReturn = 0.04 - (inf > 0.04 ? (inf - 0.04) * 0.5 : 0) + gauss(0, 0.05, rng);
  var propertyReturn = 0.03 + inf * 0.3 + gauss(0, 0.08, rng);
  var commodityReturn = inf * 0.8 + gauss(0, 0.15, rng);
  var cashReturn = Math.max(0.005, inf + 0.005);
  var equityReturn = eq * 0.5 + gauss(0, 0.02, rng);

  return linkerWeight * linkerReturn + nomBondWeight * nomBondReturn +
         propertyWeight * propertyReturn + commodityWeight * commodityReturn +
         cashWeight * cashReturn + equityWeight * equityReturn;
}

function simulate(config, returns, seed) {
  var rng = seededRng(seed || 42);
  var stocks = config.stocksStart;
  var bonds = config.bondsStart;
  var cash = config.cashStart;
  var cumInf = 1;
  var hist = [];
  var failed = false;
  var failMonth = null;
  var protMonths = 0;
  var consec = 0;
  var prot = false;
  var yearlyInf = [];

  for (var month = 0; month < config.years * 12; month++) {
    var year = Math.floor(month / 12);

    if (month > 0 && month % 12 === 0) {
      var inf = returns.inflation[year] || 0.025;
      yearlyInf.push(inf);
      cumInf *= (1 + inf);
    }
    if (year === 0 && month === 0) yearlyInf = [];

    // Calculate minimums with depletion
    var depletion = Math.max(0, 1 - year / config.duration);
    var stocksMin = config.stocksMin * cumInf * depletion;
    var bondsMin = config.bondsMin * cumInf * depletion;
    var cashMax = config.cashTarget * cumInf;

    // Calculate monthly draw
    var pa = config.taxMode === 'frozen' ? config.pa : config.pa * cumInf;
    var brl = config.taxMode === 'frozen' ? config.brl : config.brl * cumInf;
    var target = config.targetIncome * cumInf;

    var statePension = year >= config.statePensionYearsUntil ? config.statePension * cumInf : 0;
    var other = config.otherIncome * cumInf;

    var sippDraw = Math.max(0, Math.min(target, brl) - other - statePension);
    var monthDraw = (prot ? sippDraw * 0.8 : sippDraw) / 12;

    // Apply returns
    var inf = returns.inflation[year] || 0.025;
    var prevInf = year > 0 ? (returns.inflation[year - 1] || 0.025) : inf;
    var eq = returns.equity[year] || 0;
    var bondR = bondReturn(inf, eq, prevInf, rng);
    var cashR = Math.max(0.005, inf + 0.012);

    stocks *= (1 + Math.pow(1 + eq, 1/12) - 1);
    bonds *= (1 + Math.pow(1 + bondR, 1/12) - 1);
    cash *= (1 + Math.pow(1 + cashR, 1/12) - 1);

    var totalGrowth = stocks + bonds;
    var minGrowth = stocksMin + bondsMin;

    // Exit protection
    if (prot && totalGrowth > minGrowth + 5000) {
      prot = false;
      consec = 0;
    }
    if (prot) protMonths++;

    // Withdraw
    if (!prot && totalGrowth >= minGrowth + monthDraw) {
      var pS = Math.max(0, stocks - stocksMin);
      var cS = Math.max(0, bonds - bondsMin);
      var tot = pS + cS;
      if (tot > 0) {
        stocks -= monthDraw * pS / tot;
        bonds -= monthDraw * cS / tot;
        consec = 0;
      } else {
        cash -= monthDraw;
      }
    } else {
      if (cash >= monthDraw) {
        cash -= monthDraw;
        consec++;
        if (consec >= 3) prot = true;
      } else {
        var rem = monthDraw - cash;
        cash = 0;
        if (bonds > rem) bonds -= rem;
        else if (stocks > rem) stocks -= rem;
        else { failed = true; failMonth = month; }
      }
    }

    if (month % 12 === 0) {
      hist.push({
        year: year,
        total: stocks + bonds + cash,
        stocks: stocks,
        bonds: bonds,
        cash: cash,
        sippDraw: sippDraw
      });
    }
    if (failed) break;
  }

  return {
    hist: hist,
    failed: failed,
    failMonth: failMonth,
    years: failed ? failMonth / 12 : config.years,
    final: stocks + bonds + cash,
    protMonths: protMonths
  };
}

// ============ MAIN CHECK FUNCTION ============
function runCheck() {
  var totalSavings = +document.getElementById('totalSavings').value || 500000;
  var currentAge = +document.getElementById('currentAge').value || 55;
  var retireAge = +document.getElementById('retireAge').value || 90;
  var monthlyWant = +document.getElementById('monthlyWant').value || 2500;
  var statePension = +document.getElementById('statePension').value || 12000;
  var statePensionAge = +document.getElementById('statePensionAge').value || 67;
  var otherIncome = +document.getElementById('otherIncome').value || 0;

  var settings = getSettings();
  var years = retireAge - currentAge;
  var statePensionYearsUntil = Math.max(0, statePensionAge - currentAge);

  // Convert monthly want to gross yearly (approximate)
  var netMonthly = monthlyWant;
  var grossYearly = netMonthly * 12 / 0.8 + 12570 * 0.2; // Rough approximation

  // Default allocation: 50% stocks, 40% bonds, 10% cash
  var stocksStart = totalSavings * 0.50;
  var bondsStart = totalSavings * 0.40;
  var cashStart = totalSavings * 0.10;

  var config = {
    stocksStart: stocksStart,
    bondsStart: bondsStart,
    cashStart: cashStart,
    stocksMin: stocksStart * 0.8,
    bondsMin: bondsStart * 0.8,
    cashTarget: cashStart,
    years: years,
    duration: years,
    targetIncome: grossYearly,
    statePension: statePension,
    statePensionYearsUntil: statePensionYearsUntil,
    otherIncome: otherIncome,
    taxMode: settings.taxMode,
    pa: settings.pa || 12570,
    brl: settings.brl || 50270
  };

  // Run 1000 Monte Carlo simulations
  var runs = 1000;
  var yrs = Object.keys(EQUITY_RETURNS).map(Number).sort(function(a,b){return a-b;});
  var results = [];

  for (var i = 0; i < runs; i++) {
    var rng = seededRng(i * 12345);
    var ret = { equity: {}, inflation: {} };
    for (var y = 0; y < years; y++) {
      var ry = yrs[Math.floor(rng() * yrs.length)];
      ret.equity[y] = EQUITY_RETURNS[ry];
      ret.inflation[y] = INFLATION[ry] || 0.025;
    }
    results.push(simulate(config, ret, i));
  }

  // Calculate statistics
  var successes = results.filter(function(r) { return !r.failed; });
  var successRate = (successes.length / runs * 100);
  var survivalYears = results.map(function(r) { return r.years; }).sort(function(a,b){return a-b;});
  var p10Years = survivalYears[Math.floor(runs * 0.1)];

  // Calculate safe withdrawal
  var safeRate = successRate >= 90 ? 1.0 : successRate >= 80 ? 0.9 : 0.8;
  var safeMonthly = Math.round(netMonthly * safeRate / 100) * 100;

  // Percentile data for chart
  var pctData = [];
  for (var yr = 0; yr <= years; yr++) {
    var tots = results.map(function(r) {
      var h = r.hist.find(function(h) { return h.year === yr; });
      return h ? h.total : 0;
    }).sort(function(a,b){return a-b;});
    pctData.push({
      year: yr,
      p10: tots[Math.floor(runs * 0.1)] || 0,
      p25: tots[Math.floor(runs * 0.25)] || 0,
      p50: tots[Math.floor(runs * 0.5)] || 0,
      p75: tots[Math.floor(runs * 0.75)] || 0,
      p90: tots[Math.floor(runs * 0.9)] || 0
    });
  }

  // Display results
  displayResults(successRate, safeMonthly, p10Years, years, pctData, config, results);
}

function displayResults(successRate, safeMonthly, p10Years, years, pctData, config, results) {
  document.getElementById('results').classList.add('visible');

  // Verdict
  var verdict = document.getElementById('verdict');
  verdict.className = 'verdict';

  if (successRate >= 90) {
    verdict.classList.add('success');
    verdict.innerHTML = '<div class="verdict-icon">âœ“</div><h2>You\'re on track!</h2><p>Based on 1,000 market simulations, your plan has a high chance of lasting.</p>';
  } else if (successRate >= 75) {
    verdict.classList.add('warning');
    verdict.innerHTML = '<div class="verdict-icon">âš </div><h2>You might be OK</h2><p>Your plan could work, but consider reducing spending or saving more for a safety buffer.</p>';
  } else {
    verdict.classList.add('danger');
    verdict.innerHTML = '<div class="verdict-icon">âœ—</div><h2>Your plan needs work</h2><p>At this spending rate, there\'s a significant chance you\'ll run out of money. Consider the suggestions below.</p>';
  }

  // Stats
  document.getElementById('successRate').textContent = Math.round(successRate) + '%';
  document.getElementById('successRate').parentElement.className = 'stat ' + (successRate >= 90 ? 'success' : successRate >= 75 ? 'warning' : 'danger');

  document.getElementById('safeMonthly').textContent = 'Â£' + safeMonthly.toLocaleString();
  document.getElementById('yearsLast').textContent = Math.round(p10Years) + '+';

  // Recommendations
  var recsHtml = '';
  if (successRate < 90) {
    var reduction = Math.round((100 - successRate) / 2);
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Reduce monthly spending</h4><p>Cutting your spending by ' + reduction + '% would significantly improve your chances of success.</p></div>';
  }
  if (successRate < 80) {
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Work a bit longer</h4><p>Each extra year of work means one less year of withdrawals and one more year of savings.</p></div>';
  }
  if (config.cashStart < config.targetIncome * 0.5) {
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Build a cash buffer</h4><p>Having 1-2 years of expenses in cash protects you from selling stocks during a crash.</p></div>';
  }
  document.getElementById('recommendations').innerHTML = recsHtml;

  // Draw chart
  drawChart(pctData, years);

  // Detailed stats
  var finals = results.filter(function(r) { return !r.failed; }).map(function(r) { return r.final; }).sort(function(a,b){return a-b;});
  var medianFinal = finals[Math.floor(finals.length * 0.5)] || 0;
  var protRuns = results.filter(function(r) { return r.protMonths > 0; }).length;

  document.getElementById('detailedStats').innerHTML =
    '<div class="stat-grid">' +
    '<div class="stat"><div class="stat-value">' + results.filter(function(r){return r.failed;}).length + '</div><div class="stat-label">Simulations Failed</div></div>' +
    '<div class="stat"><div class="stat-value">' + formatMoney(medianFinal) + '</div><div class="stat-label">Median Final Balance</div></div>' +
    '<div class="stat"><div class="stat-value">' + protRuns + '</div><div class="stat-label">Needed Protection Mode</div></div>' +
    '</div>';
}

function drawChart(pctData, years) {
  var canvas = document.getElementById('projectionChart');
  var ctx = canvas.getContext('2d');
  var W = canvas.width = canvas.offsetWidth * 2;
  var H = canvas.height = 600;
  var pad = { l: 80, r: 40, t: 20, b: 50 };

  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.fillRect(0, 0, W, H);

  var max = Math.max.apply(null, pctData.map(function(d) { return d.p90; })) * 1.1;
  var xS = function(y) { return pad.l + (y / years) * (W - pad.l - pad.r); };
  var yS = function(v) { return H - pad.b - (v / max) * (H - pad.t - pad.b); };

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  for (var i = 0; i <= 5; i++) {
    var y = pad.t + (i/5) * (H - pad.t - pad.b);
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(W - pad.r, y);
    ctx.stroke();
  }

  // 25-75 percentile band
  ctx.fillStyle = 'rgba(240,198,116,0.25)';
  ctx.beginPath();
  pctData.forEach(function(d, i) {
    if (i === 0) ctx.moveTo(xS(d.year), yS(d.p75));
    else ctx.lineTo(xS(d.year), yS(d.p75));
  });
  for (var i = pctData.length - 1; i >= 0; i--) {
    ctx.lineTo(xS(pctData[i].year), yS(pctData[i].p25));
  }
  ctx.closePath();
  ctx.fill();

  // Median line
  ctx.strokeStyle = '#f0c674';
  ctx.lineWidth = 3;
  ctx.beginPath();
  pctData.forEach(function(d, i) {
    if (i === 0) ctx.moveTo(xS(d.year), yS(d.p50));
    else ctx.lineTo(xS(d.year), yS(d.p50));
  });
  ctx.stroke();

  // 10th percentile line
  ctx.strokeStyle = 'rgba(248,81,73,0.8)';
  ctx.lineWidth = 2;
  ctx.setLineDash([6, 4]);
  ctx.beginPath();
  pctData.forEach(function(d, i) {
    if (i === 0) ctx.moveTo(xS(d.year), yS(d.p10));
    else ctx.lineTo(xS(d.year), yS(d.p10));
  });
  ctx.stroke();
  ctx.setLineDash([]);

  // Zero line
  ctx.strokeStyle = '#f85149';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(pad.l, yS(0));
  ctx.lineTo(W - pad.r, yS(0));
  ctx.stroke();
  ctx.setLineDash([]);

  // Labels
  ctx.fillStyle = '#8b8b9b';
  ctx.font = '22px sans-serif';
  ctx.textAlign = 'right';
  for (var i = 0; i <= 5; i++) {
    ctx.fillText(formatMoney(max * (1 - i/5)), pad.l - 10, pad.t + (i/5) * (H - pad.t - pad.b) + 6);
  }
  ctx.textAlign = 'center';
  for (var y = 0; y <= years; y += 5) {
    ctx.fillText('Year ' + y, xS(y), H - pad.b + 30);
  }
}

// ============ MONTHLY TRACKER ============
function generateAdvice() {
  var month = document.getElementById('entryMonth').value;
  var stocks = +document.getElementById('entryStocks').value || 0;
  var bonds = +document.getElementById('entryBonds').value || 0;
  var cash = +document.getElementById('entryCash').value || 0;

  if (!month) {
    alert('Please select a month');
    return;
  }

  var settings = getSettings();
  var total = stocks + bonds + cash;
  var monthlyDraw = settings.targetIncome / 12;

  // Determine where to withdraw from
  var stocksSurplus = stocks - settings.stocksMin;
  var bondsSurplus = bonds - settings.bondsMin;
  var growthSurplus = stocksSurplus + bondsSurplus;

  var source, amount, reason, alert_type;

  if (growthSurplus >= monthlyDraw) {
    source = 'growth funds';
    var fromStocks = monthlyDraw * (stocksSurplus / growthSurplus);
    var fromBonds = monthlyDraw * (bondsSurplus / growthSurplus);
    amount = 'Â£' + Math.round(fromStocks).toLocaleString() + ' from stocks, Â£' + Math.round(fromBonds).toLocaleString() + ' from bonds';
    reason = 'Your growth funds are above target, so we draw from them proportionally.';
    alert_type = 'success';
  } else if (cash >= monthlyDraw) {
    source = 'cash';
    amount = 'Â£' + Math.round(monthlyDraw).toLocaleString() + ' from cash';
    reason = 'Growth funds are below target. Using cash buffer to protect your investments.';
    alert_type = 'warning';
  } else {
    source = 'emergency';
    amount = 'Â£' + Math.round(monthlyDraw).toLocaleString();
    reason = 'Warning: Cash buffer is low. Consider reducing withdrawals or rebalancing.';
    alert_type = 'danger';
  }

  var adviceHtml =
    '<div class="card" style="border-color: var(--' + alert_type + ');">' +
    '<h2>This Month\'s Recommendation</h2>' +
    '<div class="verdict ' + alert_type + '" style="padding: 24px;">' +
    '<h2 style="font-size: 20px;">Withdraw from ' + source + '</h2>' +
    '<p style="font-size: 18px; color: var(--text); margin-top: 12px;">' + amount + '</p>' +
    '</div>' +
    '<p style="color: var(--text-muted);">' + reason + '</p>' +
    '<div style="margin-top: 20px;">' +
    '<button onclick="recordWithdrawal(\'' + month + '\', ' + monthlyDraw + ', \'' + source + '\', ' + total + ')">Record This Withdrawal</button>' +
    '</div>' +
    '</div>';

  document.getElementById('monthlyAdvice').innerHTML = adviceHtml;
  document.getElementById('monthlyAdvice').classList.add('visible');
}

function recordWithdrawal(month, amount, source, balance) {
  var history = getHistory();
  history.push({
    month: month,
    amount: amount,
    source: source,
    balance: balance,
    date: new Date().toISOString()
  });
  saveHistory(history);
  renderHistory();
  alert('Withdrawal recorded!');
}

function renderHistory() {
  var history = getHistory();
  var tbody = document.getElementById('historyTable');

  if (history.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No withdrawals recorded yet</td></tr>';
    return;
  }

  tbody.innerHTML = history.slice().reverse().map(function(h) {
    return '<tr>' +
      '<td>' + h.month + '</td>' +
      '<td>Â£' + Math.round(h.amount).toLocaleString() + '</td>' +
      '<td>' + h.source + '</td>' +
      '<td>' + formatMoney(h.balance) + '</td>' +
      '</tr>';
  }).join('');
}

// ============ SETTINGS ============
function loadSettings() {
  var s = getSettings();
  document.getElementById('settingsTargetIncome').value = s.targetIncome;
  document.getElementById('settingsStocksMin').value = s.stocksMin;
  document.getElementById('settingsBondsMin').value = s.bondsMin;
  document.getElementById('settingsCashTarget').value = s.cashTarget;
  document.getElementById('settingsDuration').value = s.duration;
  document.getElementById('settingsTaxMode').value = s.taxMode;
}

function saveSettings() {
  var settings = {
    targetIncome: +document.getElementById('settingsTargetIncome').value,
    stocksMin: +document.getElementById('settingsStocksMin').value,
    bondsMin: +document.getElementById('settingsBondsMin').value,
    cashTarget: +document.getElementById('settingsCashTarget').value,
    duration: +document.getElementById('settingsDuration').value,
    taxMode: document.getElementById('settingsTaxMode').value,
    pa: 12570,
    brl: 50270
  };
  saveSettingsToStorage(settings);
  alert('Settings saved!');
}

function exportAllData() {
  var data = {
    settings: getSettings(),
    history: getHistory(),
    exportDate: new Date().toISOString(),
    version: '2.0'
  };

  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'pension-planner-backup.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importData(input) {
  if (!input.files || !input.files[0]) return;

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (data.settings) saveSettingsToStorage(data.settings);
      if (data.history) saveHistory(data.history);
      loadSettings();
      renderHistory();
      alert('Data imported successfully!');
    } catch(err) {
      alert('Error importing file: ' + err.message);
    }
  };
  reader.readAsText(input.files[0]);
}

// ============ INITIALIZATION ============
window.addEventListener('DOMContentLoaded', function() {
  // Set current month
  var now = new Date();
  var monthStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  document.getElementById('entryMonth').value = monthStr;

  loadSettings();
  renderHistory();
});
</script>

</body>
</html>
