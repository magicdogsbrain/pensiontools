<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Pension Planner">
  <meta name="theme-color" content="#0f0f1a">
  <meta name="description" content="Simple pension planning - find out if you can afford to retire">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <title>Can I Retire? - Pension Planner</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --card: #1a1a2e;
      --card-alt: #16213e;
      --text: #e8e4dc;
      --text-muted: #8b8b9b;
      --primary: #f0c674;
      --success: #2ea043;
      --warning: #e1b12c;
      --danger: #f85149;
      --info: #7eb8da;
      --border: rgba(255,255,255,0.1);
      --pension: #e8927c;
      --isa: #7eb8da;
      --gia: #a0d995;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Simple centered layout */
    .app { max-width: 800px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header { text-align: center; padding: 40px 20px 30px; }
    .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 8px; }
    .header p { color: var(--text-muted); font-size: 16px; }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text);
    }
    .card h3 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin: 24px 0 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Form elements */
    .field { margin-bottom: 20px; }
    .field label {
      display: block;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
      font-weight: 500;
    }
    .field .hint {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .field input, .field select {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 18px;
      font-weight: 500;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(0,0,0,0.4);
    }
    .field input::placeholder { color: var(--text-muted); }

    /* Input with prefix */
    .input-with-prefix {
      display: flex;
      align-items: stretch;
    }
    .input-prefix {
      background: var(--card-alt);
      border: 1px solid var(--border);
      border-right: none;
      border-radius: 10px 0 0 10px;
      padding: 14px 16px;
      font-size: 18px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
    }
    .input-with-prefix input {
      border-radius: 0 10px 10px 0;
    }

    /* Grid */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media (max-width: 600px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }

    /* Buttons */
    button {
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--primary) 0%, #e8927c 100%);
      border: none;
      border-radius: 12px;
      color: #1a1a2e;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(240,198,116,0.3); }
    button:active { transform: translateY(0); }
    button.secondary {
      background: var(--card-alt);
      color: var(--text);
      border: 1px solid var(--border);
    }
    button.secondary:hover {
      background: var(--card);
      box-shadow: none;
    }
    button.small { padding: 10px 20px; font-size: 14px; width: auto; }

    /* Result display */
    .result { display: none; }
    .result.visible { display: block; }

    .verdict {
      text-align: center;
      padding: 40px 20px;
      border-radius: 16px;
      margin-bottom: 24px;
    }
    .verdict.success { background: linear-gradient(135deg, rgba(46,160,67,0.15) 0%, rgba(46,160,67,0.05) 100%); border: 2px solid var(--success); }
    .verdict.warning { background: linear-gradient(135deg, rgba(225,177,44,0.15) 0%, rgba(225,177,44,0.05) 100%); border: 2px solid var(--warning); }
    .verdict.danger { background: linear-gradient(135deg, rgba(248,81,73,0.15) 0%, rgba(248,81,73,0.05) 100%); border: 2px solid var(--danger); }

    .verdict-icon { font-size: 64px; margin-bottom: 16px; }
    .verdict h2 { font-size: 28px; margin-bottom: 8px; }
    .verdict.success h2 { color: var(--success); }
    .verdict.warning h2 { color: var(--warning); }
    .verdict.danger h2 { color: var(--danger); }
    .verdict p { color: var(--text-muted); font-size: 16px; max-width: 400px; margin: 0 auto; }

    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
    @media (max-width: 500px) { .stat-grid { grid-template-columns: 1fr; } }

    .stat {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 28px; font-weight: 600; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat.success .stat-value { color: var(--success); }
    .stat.warning .stat-value { color: var(--warning); }
    .stat.danger .stat-value { color: var(--danger); }

    /* Account type badges */
    .account-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .account-badge.pension { background: rgba(232,146,124,0.2); color: var(--pension); }
    .account-badge.isa { background: rgba(126,184,218,0.2); color: var(--isa); }
    .account-badge.gia { background: rgba(160,217,149,0.2); color: var(--gia); }

    /* Account input sections */
    .account-section {
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .account-section.pension { background: rgba(232,146,124,0.08); border: 1px solid rgba(232,146,124,0.3); }
    .account-section.isa { background: rgba(126,184,218,0.08); border: 1px solid rgba(126,184,218,0.3); }
    .account-section.gia { background: rgba(160,217,149,0.08); border: 1px solid rgba(160,217,149,0.3); }
    .account-section h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .account-section.pension h4 { color: var(--pension); }
    .account-section.isa h4 { color: var(--isa); }
    .account-section.gia h4 { color: var(--gia); }
    .account-section .tax-note {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    /* Recommendations */
    .recommendation {
      background: rgba(126,184,218,0.1);
      border: 1px solid rgba(126,184,218,0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .recommendation h4 { color: var(--info); margin-bottom: 8px; font-size: 14px; }
    .recommendation p { color: var(--text-muted); font-size: 14px; margin: 0; }

    /* Tax breakdown */
    .tax-breakdown {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .tax-breakdown h4 {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tax-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .tax-row:last-child { border-bottom: none; }
    .tax-row .label { display: flex; align-items: center; gap: 10px; }
    .tax-row .amount { font-weight: 600; }
    .tax-row.total { font-size: 18px; padding-top: 16px; }
    .tax-row.total .label { color: var(--text); }

    /* Chart container */
    .chart-container {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }
    .chart-title {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    canvas { width: 100% !important; height: 300px !important; }

    /* Legend */
    .legend { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 12px; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 3px; }

    /* Expandable sections */
    .expand-section { margin-top: 24px; }
    .expand-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      border: 1px solid var(--border);
      transition: background 0.2s;
    }
    .expand-toggle:hover { background: rgba(0,0,0,0.3); }
    .expand-toggle .arrow { transition: transform 0.2s; }
    .expand-toggle.open .arrow { transform: rotate(180deg); }
    .expand-content {
      display: none;
      padding: 20px 0 0;
    }
    .expand-content.open { display: block; }

    /* Navigation tabs */
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .nav-tab {
      padding: 12px 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-tab:hover { background: var(--card-alt); }
    .nav-tab.active {
      background: var(--card-alt);
      color: var(--primary);
      border-color: var(--primary);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Info boxes */
    .info-box {
      background: rgba(126,184,218,0.1);
      border: 1px solid rgba(126,184,218,0.3);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      font-size: 14px;
      color: var(--text-muted);
    }
    .info-box strong { color: var(--info); }

    /* Tables */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--card-alt); color: var(--text-muted); font-size: 12px; text-transform: uppercase; }

    /* Monthly tracker */
    .monthly-entry {
      background: linear-gradient(135deg, var(--card-alt) 0%, var(--card) 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    /* Hidden utility */
    .hidden { display: none !important; }

    /* Footer */
    .footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .footer a { color: var(--primary); text-decoration: none; }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: rgba(30,30,30,0.95);
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      color: #fff;
      pointer-events: none;
      z-index: 1000;
      max-width: 300px;
      display: none;
    }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <h1>Can I Retire?</h1>
    <p>Find out if your savings will last through retirement</p>
  </header>

  <!-- Navigation -->
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('check')">Check My Plan</button>
    <button class="nav-tab" onclick="showTab('monthly')">Monthly Tracker</button>
    <button class="nav-tab" onclick="showTab('settings')">Settings</button>
  </div>

  <!-- TAB 1: Check My Plan -->
  <div id="tab-check" class="tab-content active">
    <div class="card">
      <h2>Your Savings</h2>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Enter how much you have in each type of account. Different accounts are taxed differently, so this matters for planning.</p>

      <div class="account-section pension">
        <h4>
          <span class="account-badge pension">Pension</span>
          Pension / SIPP
        </h4>
        <div class="tax-note">25% tax-free, then taxed as income when you withdraw</div>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="pensionAmount" placeholder="300000" value="300000">
        </div>
      </div>

      <div class="account-section isa">
        <h4>
          <span class="account-badge isa">ISA</span>
          ISA (Stocks & Shares or Cash)
        </h4>
        <div class="tax-note">Completely tax-free withdrawals</div>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="isaAmount" placeholder="100000" value="100000">
        </div>
      </div>

      <div class="account-section gia">
        <h4>
          <span class="account-badge gia">GIA</span>
          General Investment Account
        </h4>
        <div class="tax-note">Subject to Capital Gains Tax on profits (Â£3,000 annual allowance)</div>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="giaAmount" placeholder="100000" value="100000">
        </div>
      </div>

      <h3>About You</h3>
      <div class="grid-2">
        <div class="field">
          <label>How old are you now?</label>
          <input type="number" id="currentAge" placeholder="55" value="55">
        </div>
        <div class="field">
          <label>Plan until what age?</label>
          <input type="number" id="retireAge" placeholder="90" value="90">
          <div class="hint">How long your money needs to last</div>
        </div>
      </div>

      <h3>Income Needs</h3>
      <div class="field">
        <label>How much do you want per month (after tax)?</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="monthlyWant" placeholder="2500" value="2500">
        </div>
        <div class="hint">The amount you want in your pocket each month</div>
      </div>

      <div class="expand-section">
        <div class="expand-toggle" onclick="toggleExpand(this)">
          <span>Other income sources (State Pension, etc.)</span>
          <span class="arrow">â–¼</span>
        </div>
        <div class="expand-content">
          <div class="grid-2">
            <div class="field">
              <label>State Pension (per year)</label>
              <div class="input-with-prefix">
                <span class="input-prefix">Â£</span>
                <input type="number" id="statePension" placeholder="12000" value="12000">
              </div>
            </div>
            <div class="field">
              <label>State Pension starts at age</label>
              <input type="number" id="statePensionAge" placeholder="67" value="67">
            </div>
          </div>
          <div class="field">
            <label>Other guaranteed income (per year)</label>
            <div class="input-with-prefix">
              <span class="input-prefix">Â£</span>
              <input type="number" id="otherIncome" placeholder="0" value="0">
            </div>
            <div class="hint">e.g., final salary pension, rental income</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 28px;">
        <button onclick="runCheck()">Check My Plan</button>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="result">
      <div id="verdict" class="verdict success">
        <div class="verdict-icon">âœ“</div>
        <h2>You're on track!</h2>
        <p>Based on 1,000 market simulations, your plan has a high chance of success.</p>
      </div>

      <div class="stat-grid">
        <div class="stat success">
          <div class="stat-value" id="successRate">92%</div>
          <div class="stat-label">Chance of Success</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="totalSavings">Â£500k</div>
          <div class="stat-label">Total Savings</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="yearsLast">35+</div>
          <div class="stat-label">Years Your Money Lasts</div>
        </div>
      </div>

      <div class="tax-breakdown" id="taxStrategy">
        <h4>Tax-Efficient Withdrawal Order</h4>
        <div class="tax-row">
          <span class="label"><span class="account-badge pension">1st</span> Pension (up to tax-free allowance)</span>
          <span class="amount" id="taxFreePension">Â£12,570/yr</span>
        </div>
        <div class="tax-row">
          <span class="label"><span class="account-badge isa">2nd</span> ISA (tax-free)</span>
          <span class="amount" id="isaWithdraw">Â£0/yr</span>
        </div>
        <div class="tax-row">
          <span class="label"><span class="account-badge gia">3rd</span> GIA (using CGT allowance)</span>
          <span class="amount" id="giaWithdraw">Â£0/yr</span>
        </div>
        <div class="tax-row">
          <span class="label"><span class="account-badge pension">4th</span> More Pension (taxed)</span>
          <span class="amount" id="taxedPension">Â£0/yr</span>
        </div>
        <div class="tax-row total">
          <span class="label">Your net income</span>
          <span class="amount" id="netIncome">Â£30,000/yr</span>
        </div>
      </div>

      <div id="recommendations"></div>

      <div class="chart-container">
        <div class="chart-title">How your money could grow (or shrink)</div>
        <canvas id="projectionChart"></canvas>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot" style="background: rgba(240,198,116,0.3);"></div> Most likely range</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--primary);"></div> Median outcome</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--danger);"></div> Worst 10%</div>
        </div>
      </div>

      <div class="expand-section">
        <div class="expand-toggle" onclick="toggleExpand(this)">
          <span>Show detailed breakdown</span>
          <span class="arrow">â–¼</span>
        </div>
        <div class="expand-content">
          <div id="detailedStats"></div>
        </div>
      </div>

      <div style="margin-top: 24px; text-align: center;">
        <button class="secondary small" onclick="runCheck()">Run Again</button>
      </div>
    </div>
  </div>

  <!-- TAB 2: Monthly Tracker -->
  <div id="tab-monthly" class="tab-content">
    <div class="card">
      <h2>This Month's Withdrawal</h2>
      <p style="color: var(--text-muted); margin-bottom: 24px;">Enter your current account values and I'll tell you where to take money from for the best tax efficiency.</p>

      <div class="field">
        <label>Month</label>
        <input type="month" id="entryMonth">
      </div>

      <h3>Current Account Balances</h3>

      <div class="account-section pension">
        <h4><span class="account-badge pension">Pension</span> Current Value</h4>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="entryPension" placeholder="300000">
        </div>
      </div>

      <div class="account-section isa">
        <h4><span class="account-badge isa">ISA</span> Current Value</h4>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="entryIsa" placeholder="100000">
        </div>
      </div>

      <div class="account-section gia">
        <h4><span class="account-badge gia">GIA</span> Current Value</h4>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="entryGia" placeholder="100000">
        </div>
      </div>

      <div class="field">
        <label>How much do you need this month?</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="entryNeed" placeholder="2500" value="2500">
        </div>
      </div>

      <div style="margin-top: 24px;">
        <button onclick="generateAdvice()">What Should I Do?</button>
      </div>
    </div>

    <div id="monthlyAdvice" class="result">
      <!-- Filled by JS -->
    </div>

    <div class="card">
      <h2>Withdrawal History</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Month</th>
              <th>Withdrawn</th>
              <th>From</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody id="historyTable">
            <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No withdrawals recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 3: Settings -->
  <div id="tab-settings" class="tab-content">
    <div class="card">
      <h2>Tax Assumptions</h2>
      <p style="color: var(--text-muted); margin-bottom: 20px;">These settings affect how tax is calculated in the simulations.</p>

      <div class="field">
        <label>Personal Allowance (tax-free income)</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="settingsPA" value="12570">
        </div>
        <div class="hint">Currently Â£12,570 for 2024/25</div>
      </div>

      <div class="field">
        <label>Basic Rate Limit</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="settingsBRL" value="50270">
        </div>
        <div class="hint">Income above this is taxed at 40%</div>
      </div>

      <div class="field">
        <label>Capital Gains Tax Allowance</label>
        <div class="input-with-prefix">
          <span class="input-prefix">Â£</span>
          <input type="number" id="settingsCGT" value="3000">
        </div>
        <div class="hint">Annual tax-free gains for GIA (currently Â£3,000)</div>
      </div>

      <div class="field">
        <label>Will tax thresholds rise with inflation?</label>
        <select id="settingsTaxMode">
          <option value="inflates">Yes - thresholds rise with inflation (optimistic)</option>
          <option value="frozen">No - thresholds stay frozen (pessimistic)</option>
        </select>
        <div class="hint">Frozen thresholds mean you pay more tax over time due to "fiscal drag"</div>
      </div>

      <div style="margin-top: 28px;">
        <button onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

    <div class="card">
      <h2>Import / Export Data</h2>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="secondary small" onclick="exportAllData()">Export All Data</button>
        <button class="secondary small" onclick="document.getElementById('importFile').click()">Import Data</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Pension Planner v2.1 | <a href="#" onclick="showTab('settings')">Settings</a></p>
    <p style="margin-top: 8px;">This is not financial advice. Always consult a qualified advisor.</p>
  </footer>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
// ============ HISTORICAL DATA ============
var EQUITY_RETURNS = {1928:0.4781,1929:-0.172,1930:-0.338,1931:-0.527,1932:-0.231,1933:0.669,1934:0.041,1935:0.3879,1936:0.2492,1937:-0.3839,1938:0.2846,1939:-0.0278,1940:-0.1278,1941:-0.1552,1942:0.0782,1943:0.1382,1944:0.1226,1945:0.2665,1946:-0.0818,1947:0.0225,1948:-0.0246,1949:0.1279,1950:0.1787,1951:0.1463,1952:0.0837,1953:-0.0377,1954:0.4399,1955:0.2084,1956:0.0262,1957:-0.1278,1958:0.3396,1959:0.1612,1960:-0.0912,1961:0.1889,1962:-0.1081,1963:0.1715,1964:0.1478,1965:0.1058,1966:-0.1858,1967:0.1506,1968:0.0457,1969:-0.1524,1970:0.0482,1971:0.0627,1972:0.1476,1973:-0.1652,1974:-0.2777,1975:0.3815,1976:0.1774,1977:-0.1271,1978:-0.0303,1979:0.0414,1980:0.1493,1981:-0.0909,1982:0.1976,1983:0.2027,1984:-0.0365,1985:0.2778,1986:0.2278,1987:0.0227,1988:0.1185,1989:0.2697,1990:-0.0456,1991:0.2013,1992:0.0440,1993:0.1372,1994:0.0218,1995:0.3345,1996:0.2601,1997:0.2264,1998:0.1627,1999:0.2516,2000:-0.0617,2001:-0.0727,2002:-0.1679,2003:0.2525,2004:0.0333,2005:-0.0061,2006:0.1618,2007:0.0648,2008:-0.3355,2009:0.1882,2010:0.1102,2011:0.0556,2012:0.0728,2013:0.2665,2014:0.0775,2015:-0.0230,2016:0.1342,2017:0.2511,2018:-0.0583,2019:0.2234,2020:0.0726,2021:0.1873,2022:-0.0878,2023:0.1399,2024:0.1299};
var INFLATION = {1928:-0.012,1929:0.002,1930:-0.060,1931:-0.094,1932:-0.103,1933:0.005,1934:0.021,1935:0.030,1936:0.014,1937:0.028,1938:-0.020,1939:-0.014,1940:0.010,1941:0.099,1942:0.090,1943:0.030,1944:0.023,1945:0.023,1946:0.186,1947:0.087,1948:0.030,1949:-0.020,1950:0.059,1951:0.060,1952:0.009,1953:0.006,1954:-0.007,1955:0.004,1956:0.030,1957:0.028,1958:0.017,1959:0.015,1960:0.014,1961:0.007,1962:0.013,1963:0.017,1964:0.010,1965:0.019,1966:0.034,1967:0.028,1968:0.046,1969:0.062,1970:0.055,1971:0.033,1972:0.034,1973:0.087,1974:0.124,1975:0.069,1976:0.048,1977:0.067,1978:0.090,1979:0.133,1980:0.125,1981:0.089,1982:0.038,1983:0.038,1984:0.040,1985:0.038,1986:0.011,1987:0.044,1988:0.044,1989:0.046,1990:0.061,1991:0.030,1992:0.029,1993:0.027,1994:0.026,1995:0.025,1996:0.034,1997:0.017,1998:0.016,1999:0.027,2000:0.034,2001:0.016,2002:0.024,2003:0.019,2004:0.033,2005:0.034,2006:0.025,2007:0.041,2008:0.001,2009:0.027,2010:0.015,2011:0.030,2012:0.017,2013:0.015,2014:0.008,2015:0.007,2016:0.021,2017:0.021,2018:0.019,2019:0.023,2020:0.012,2021:0.070,2022:0.065,2023:0.032,2024:0.029};

var STORAGE_KEY = 'pension_planner_v2';
var HISTORY_KEY = 'pension_history_v2';

// ============ UTILITIES ============
function seededRng(seed) {
  var s = seed;
  return function() {
    s = Math.sin(s) * 10000;
    return s - Math.floor(s);
  };
}

function gauss(m, std, rng) {
  return Math.sqrt(-2 * Math.log(rng())) * Math.cos(2 * Math.PI * rng()) * std + m;
}

function formatMoney(n) {
  if (n >= 1000000) return 'Â£' + (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return 'Â£' + Math.round(n / 1000) + 'k';
  return 'Â£' + Math.round(n);
}

function formatMoneyFull(n) {
  return 'Â£' + Math.round(n).toLocaleString();
}

// ============ TAB NAVIGATION ============
function showTab(tab) {
  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  document.querySelector('.nav-tab[onclick*="' + tab + '"]').classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

function toggleExpand(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
}

// ============ STORAGE ============
function getSettings() {
  try {
    var data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (data) return data;
  } catch(e) {}
  return {
    pa: 12570,
    brl: 50270,
    cgtAllowance: 3000,
    taxMode: 'frozen'
  };
}

function saveSettingsToStorage(settings) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
}

function getHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  } catch(e) { return []; }
}

function saveHistory(history) {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

// ============ TAX CALCULATIONS ============
function calculateTax(grossIncome, settings, cumInf) {
  var pa = settings.taxMode === 'frozen' ? settings.pa : settings.pa * cumInf;
  var brl = settings.taxMode === 'frozen' ? settings.brl : settings.brl * cumInf;

  var taxable = Math.max(0, grossIncome - pa);
  var basicBand = Math.max(0, brl - pa);

  var basicTax = Math.min(taxable, basicBand) * 0.20;
  var higherTax = Math.max(0, taxable - basicBand) * 0.40;

  return basicTax + higherTax;
}

function calculateOptimalWithdrawal(needed, pension, isa, gia, settings, cumInf) {
  // Calculate how much gross pension income to get 'needed' net
  // Strategy: Use pension up to PA, then ISA, then GIA CGT allowance, then more pension

  var pa = settings.taxMode === 'frozen' ? settings.pa : settings.pa * cumInf;
  var cgtAllowance = settings.taxMode === 'frozen' ? settings.cgtAllowance : settings.cgtAllowance * cumInf;

  var result = {
    pensionTaxFree: 0,
    pensionTaxed: 0,
    isaWithdraw: 0,
    giaWithdraw: 0,
    totalGross: 0,
    totalNet: 0,
    tax: 0
  };

  var remaining = needed;

  // 1. Pension up to Personal Allowance (tax-free income)
  var pensionTaxFree = Math.min(pa, pension, remaining);
  result.pensionTaxFree = pensionTaxFree;
  remaining -= pensionTaxFree;

  if (remaining <= 0) {
    result.totalGross = result.pensionTaxFree;
    result.totalNet = result.pensionTaxFree;
    return result;
  }

  // 2. ISA withdrawals (completely tax-free)
  var isaWithdraw = Math.min(isa, remaining);
  result.isaWithdraw = isaWithdraw;
  remaining -= isaWithdraw;

  if (remaining <= 0) {
    result.totalGross = result.pensionTaxFree + result.isaWithdraw;
    result.totalNet = result.totalGross;
    return result;
  }

  // 3. GIA using CGT allowance (assuming ~50% of withdrawal is gain)
  // Can withdraw ~2x the CGT allowance before paying tax
  var giaMaxTaxFree = cgtAllowance * 2; // Assuming 50% gain
  var giaWithdraw = Math.min(gia, giaMaxTaxFree, remaining);
  result.giaWithdraw = giaWithdraw;
  remaining -= giaWithdraw;

  if (remaining <= 0) {
    result.totalGross = result.pensionTaxFree + result.isaWithdraw + result.giaWithdraw;
    result.totalNet = result.totalGross;
    return result;
  }

  // 4. More pension (will be taxed at 20% basic rate)
  // Need to gross up: if we need X net after 20% tax, we need X / 0.8 gross
  var pensionTaxedGross = remaining / 0.8;
  var availablePension = pension - result.pensionTaxFree;

  if (pensionTaxedGross <= availablePension) {
    result.pensionTaxed = pensionTaxedGross;
    result.tax = pensionTaxedGross * 0.2;
  } else {
    // Use all available pension
    result.pensionTaxed = availablePension;
    result.tax = availablePension * 0.2;
    remaining = remaining - (availablePension * 0.8);

    // Still need more - use remaining ISA
    var moreIsa = Math.min(isa - result.isaWithdraw, remaining);
    result.isaWithdraw += moreIsa;
    remaining -= moreIsa;

    // Then more GIA (will pay CGT on gains above allowance)
    if (remaining > 0) {
      var moreGia = Math.min(gia - result.giaWithdraw, remaining * 1.1); // Gross up for ~10% CGT
      result.giaWithdraw += moreGia;
      result.tax += moreGia * 0.05; // Rough CGT estimate
    }
  }

  result.totalGross = result.pensionTaxFree + result.pensionTaxed + result.isaWithdraw + result.giaWithdraw;
  result.totalNet = result.totalGross - result.tax;

  return result;
}

// ============ SIMULATION ENGINE ============
function bondReturn(inf, eq, prevInf, rng) {
  var linkerWeight = 0.15, nomBondWeight = 0.30, propertyWeight = 0.20;
  var commodityWeight = 0.10, cashWeight = 0.10, equityWeight = 0.15;

  var laggedInf = prevInf !== undefined ? prevInf : inf;
  if (laggedInf > 0.045) {
    var reactionQuality = rng() > 0.30 ? 1.0 : 0.5;
    linkerWeight = 0.15 + (0.20 * reactionQuality);
    nomBondWeight = 0.30 - (0.10 * reactionQuality);
    equityWeight = 0.15 - (0.05 * reactionQuality);
  }

  var linkerReturn = inf + 0.005 + gauss(0, 0.03, rng);
  var nomBondReturn = 0.04 - (inf > 0.04 ? (inf - 0.04) * 0.5 : 0) + gauss(0, 0.05, rng);
  var propertyReturn = 0.03 + inf * 0.3 + gauss(0, 0.08, rng);
  var commodityReturn = inf * 0.8 + gauss(0, 0.15, rng);
  var cashReturn = Math.max(0.005, inf + 0.005);
  var equityReturn = eq * 0.5 + gauss(0, 0.02, rng);

  return linkerWeight * linkerReturn + nomBondWeight * nomBondReturn +
         propertyWeight * propertyReturn + commodityWeight * commodityReturn +
         cashWeight * cashReturn + equityWeight * equityReturn;
}

function simulate(config, returns, seed) {
  var rng = seededRng(seed || 42);

  // Each account type with its own balance
  var pension = config.pensionStart;
  var isa = config.isaStart;
  var gia = config.giaStart;

  var cumInf = 1;
  var hist = [];
  var failed = false;
  var failMonth = null;

  for (var month = 0; month < config.years * 12; month++) {
    var year = Math.floor(month / 12);

    if (month > 0 && month % 12 === 0) {
      var inf = returns.inflation[year] || 0.025;
      cumInf *= (1 + inf);
    }

    // Apply returns (assuming 70% equity / 30% bonds allocation across all accounts)
    var inf = returns.inflation[year] || 0.025;
    var prevInf = year > 0 ? (returns.inflation[year - 1] || 0.025) : inf;
    var eq = returns.equity[year] || 0;
    var bondR = bondReturn(inf, eq, prevInf, rng);

    var blendedReturn = eq * 0.7 + bondR * 0.3;
    var monthlyReturn = Math.pow(1 + blendedReturn, 1/12) - 1;

    pension *= (1 + monthlyReturn);
    isa *= (1 + monthlyReturn);
    gia *= (1 + monthlyReturn);

    // Monthly withdrawal
    var targetNetMonthly = config.targetNetMonthly * cumInf;

    // State pension (if applicable)
    var statePensionMonthly = 0;
    if (year >= config.statePensionYearsUntil) {
      statePensionMonthly = (config.statePension * cumInf) / 12;
    }
    var otherIncomeMonthly = (config.otherIncome * cumInf) / 12;

    var neededFromSavings = Math.max(0, targetNetMonthly - statePensionMonthly - otherIncomeMonthly);

    // Calculate optimal withdrawal
    var withdrawal = calculateOptimalWithdrawal(
      neededFromSavings,
      pension,
      isa,
      gia,
      config.settings,
      cumInf
    );

    // Apply withdrawals
    pension -= (withdrawal.pensionTaxFree + withdrawal.pensionTaxed);
    isa -= withdrawal.isaWithdraw;
    gia -= withdrawal.giaWithdraw;

    // Check for failure
    if (pension < 0 || isa < 0 || gia < 0) {
      pension = Math.max(0, pension);
      isa = Math.max(0, isa);
      gia = Math.max(0, gia);
    }

    var total = pension + isa + gia;
    if (total < neededFromSavings * 0.5 && neededFromSavings > 100) {
      failed = true;
      failMonth = month;
    }

    if (month % 12 === 0) {
      hist.push({
        year: year,
        total: pension + isa + gia,
        pension: pension,
        isa: isa,
        gia: gia
      });
    }
    if (failed) break;
  }

  return {
    hist: hist,
    failed: failed,
    failMonth: failMonth,
    years: failed ? failMonth / 12 : config.years,
    final: pension + isa + gia
  };
}

// ============ MAIN CHECK FUNCTION ============
function runCheck() {
  var pensionAmount = +document.getElementById('pensionAmount').value || 0;
  var isaAmount = +document.getElementById('isaAmount').value || 0;
  var giaAmount = +document.getElementById('giaAmount').value || 0;
  var currentAge = +document.getElementById('currentAge').value || 55;
  var retireAge = +document.getElementById('retireAge').value || 90;
  var monthlyWant = +document.getElementById('monthlyWant').value || 2500;
  var statePension = +document.getElementById('statePension').value || 12000;
  var statePensionAge = +document.getElementById('statePensionAge').value || 67;
  var otherIncome = +document.getElementById('otherIncome').value || 0;

  var settings = getSettings();
  var years = retireAge - currentAge;
  var statePensionYearsUntil = Math.max(0, statePensionAge - currentAge);
  var totalSavings = pensionAmount + isaAmount + giaAmount;

  var config = {
    pensionStart: pensionAmount,
    isaStart: isaAmount,
    giaStart: giaAmount,
    years: years,
    targetNetMonthly: monthlyWant,
    statePension: statePension,
    statePensionYearsUntil: statePensionYearsUntil,
    otherIncome: otherIncome,
    settings: settings
  };

  // Run 1000 Monte Carlo simulations
  var runs = 1000;
  var yrs = Object.keys(EQUITY_RETURNS).map(Number).sort(function(a,b){return a-b;});
  var results = [];

  for (var i = 0; i < runs; i++) {
    var rng = seededRng(i * 12345);
    var ret = { equity: {}, inflation: {} };
    for (var y = 0; y < years; y++) {
      var ry = yrs[Math.floor(rng() * yrs.length)];
      ret.equity[y] = EQUITY_RETURNS[ry];
      ret.inflation[y] = INFLATION[ry] || 0.025;
    }
    results.push(simulate(config, ret, i));
  }

  // Calculate statistics
  var successes = results.filter(function(r) { return !r.failed; });
  var successRate = (successes.length / runs * 100);
  var survivalYears = results.map(function(r) { return r.years; }).sort(function(a,b){return a-b;});
  var p10Years = survivalYears[Math.floor(runs * 0.1)];

  // Calculate first year withdrawal strategy (for display)
  var firstYearStrategy = calculateOptimalWithdrawal(
    monthlyWant * 12,
    pensionAmount,
    isaAmount,
    giaAmount,
    settings,
    1
  );

  // Percentile data for chart
  var pctData = [];
  for (var yr = 0; yr <= years; yr++) {
    var tots = results.map(function(r) {
      var h = r.hist.find(function(h) { return h.year === yr; });
      return h ? h.total : 0;
    }).sort(function(a,b){return a-b;});
    pctData.push({
      year: yr,
      p10: tots[Math.floor(runs * 0.1)] || 0,
      p25: tots[Math.floor(runs * 0.25)] || 0,
      p50: tots[Math.floor(runs * 0.5)] || 0,
      p75: tots[Math.floor(runs * 0.75)] || 0,
      p90: tots[Math.floor(runs * 0.9)] || 0
    });
  }

  // Display results
  displayResults(successRate, totalSavings, p10Years, years, pctData, config, results, firstYearStrategy, monthlyWant);
}

function displayResults(successRate, totalSavings, p10Years, years, pctData, config, results, strategy, monthlyWant) {
  document.getElementById('results').classList.add('visible');

  // Verdict
  var verdict = document.getElementById('verdict');
  verdict.className = 'verdict';

  if (successRate >= 90) {
    verdict.classList.add('success');
    verdict.innerHTML = '<div class="verdict-icon">âœ“</div><h2>You\'re on track!</h2><p>Based on 1,000 market simulations, your plan has a high chance of lasting.</p>';
  } else if (successRate >= 75) {
    verdict.classList.add('warning');
    verdict.innerHTML = '<div class="verdict-icon">âš </div><h2>You might be OK</h2><p>Your plan could work, but consider reducing spending or saving more for a safety buffer.</p>';
  } else {
    verdict.classList.add('danger');
    verdict.innerHTML = '<div class="verdict-icon">âœ—</div><h2>Your plan needs work</h2><p>At this spending rate, there\'s a significant chance you\'ll run out of money. Consider the suggestions below.</p>';
  }

  // Stats
  document.getElementById('successRate').textContent = Math.round(successRate) + '%';
  document.getElementById('successRate').parentElement.className = 'stat ' + (successRate >= 90 ? 'success' : successRate >= 75 ? 'warning' : 'danger');

  document.getElementById('totalSavings').textContent = formatMoney(totalSavings);
  document.getElementById('yearsLast').textContent = Math.round(p10Years) + '+';

  // Tax strategy breakdown
  document.getElementById('taxFreePension').textContent = formatMoneyFull(strategy.pensionTaxFree) + '/yr';
  document.getElementById('isaWithdraw').textContent = formatMoneyFull(strategy.isaWithdraw) + '/yr';
  document.getElementById('giaWithdraw').textContent = formatMoneyFull(strategy.giaWithdraw) + '/yr';
  document.getElementById('taxedPension').textContent = formatMoneyFull(strategy.pensionTaxed) + '/yr';
  document.getElementById('netIncome').textContent = formatMoneyFull(monthlyWant * 12) + '/yr';

  // Recommendations
  var recsHtml = '';
  if (successRate < 90) {
    var reduction = Math.round((100 - successRate) / 2);
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Reduce monthly spending</h4><p>Cutting your spending by ' + reduction + '% would significantly improve your chances of success.</p></div>';
  }
  if (successRate < 80) {
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Work a bit longer</h4><p>Each extra year of work means one less year of withdrawals and one more year of savings.</p></div>';
  }
  if (config.isaStart < monthlyWant * 12) {
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Build up your ISA</h4><p>ISA withdrawals are completely tax-free. Having more in ISAs gives you flexible, tax-efficient income.</p></div>';
  }
  if (config.pensionStart > 0 && config.isaStart === 0 && config.giaStart === 0) {
    recsHtml += '<div class="recommendation"><h4>ðŸ’¡ Diversify your accounts</h4><p>Having all your savings in a pension limits flexibility. Consider ISAs for tax-free growth and access.</p></div>';
  }
  document.getElementById('recommendations').innerHTML = recsHtml;

  // Draw chart
  drawChart(pctData, years);

  // Detailed stats
  var finals = results.filter(function(r) { return !r.failed; }).map(function(r) { return r.final; }).sort(function(a,b){return a-b;});
  var medianFinal = finals[Math.floor(finals.length * 0.5)] || 0;

  document.getElementById('detailedStats').innerHTML =
    '<div class="stat-grid">' +
    '<div class="stat"><div class="stat-value">' + results.filter(function(r){return r.failed;}).length + '</div><div class="stat-label">Simulations Failed</div></div>' +
    '<div class="stat"><div class="stat-value">' + formatMoney(medianFinal) + '</div><div class="stat-label">Median Final Balance</div></div>' +
    '<div class="stat"><div class="stat-value">' + Math.round(strategy.tax) + '</div><div class="stat-label">Est. First Year Tax</div></div>' +
    '</div>';
}

function drawChart(pctData, years) {
  var canvas = document.getElementById('projectionChart');
  var ctx = canvas.getContext('2d');
  var W = canvas.width = canvas.offsetWidth * 2;
  var H = canvas.height = 600;
  var pad = { l: 80, r: 40, t: 20, b: 50 };

  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.fillRect(0, 0, W, H);

  var max = Math.max.apply(null, pctData.map(function(d) { return d.p90; })) * 1.1;
  var xS = function(y) { return pad.l + (y / years) * (W - pad.l - pad.r); };
  var yS = function(v) { return H - pad.b - (v / max) * (H - pad.t - pad.b); };

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  for (var i = 0; i <= 5; i++) {
    var y = pad.t + (i/5) * (H - pad.t - pad.b);
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(W - pad.r, y);
    ctx.stroke();
  }

  // 25-75 percentile band
  ctx.fillStyle = 'rgba(240,198,116,0.25)';
  ctx.beginPath();
  pctData.forEach(function(d, i) {
    if (i === 0) ctx.moveTo(xS(d.year), yS(d.p75));
    else ctx.lineTo(xS(d.year), yS(d.p75));
  });
  for (var i = pctData.length - 1; i >= 0; i--) {
    ctx.lineTo(xS(pctData[i].year), yS(pctData[i].p25));
  }
  ctx.closePath();
  ctx.fill();

  // Median line
  ctx.strokeStyle = '#f0c674';
  ctx.lineWidth = 3;
  ctx.beginPath();
  pctData.forEach(function(d, i) {
    if (i === 0) ctx.moveTo(xS(d.year), yS(d.p50));
    else ctx.lineTo(xS(d.year), yS(d.p50));
  });
  ctx.stroke();

  // 10th percentile line
  ctx.strokeStyle = 'rgba(248,81,73,0.8)';
  ctx.lineWidth = 2;
  ctx.setLineDash([6, 4]);
  ctx.beginPath();
  pctData.forEach(function(d, i) {
    if (i === 0) ctx.moveTo(xS(d.year), yS(d.p10));
    else ctx.lineTo(xS(d.year), yS(d.p10));
  });
  ctx.stroke();
  ctx.setLineDash([]);

  // Zero line
  ctx.strokeStyle = '#f85149';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(pad.l, yS(0));
  ctx.lineTo(W - pad.r, yS(0));
  ctx.stroke();
  ctx.setLineDash([]);

  // Labels
  ctx.fillStyle = '#8b8b9b';
  ctx.font = '22px sans-serif';
  ctx.textAlign = 'right';
  for (var i = 0; i <= 5; i++) {
    ctx.fillText(formatMoney(max * (1 - i/5)), pad.l - 10, pad.t + (i/5) * (H - pad.t - pad.b) + 6);
  }
  ctx.textAlign = 'center';
  for (var y = 0; y <= years; y += 5) {
    ctx.fillText('Year ' + y, xS(y), H - pad.b + 30);
  }
}

// ============ MONTHLY TRACKER ============
function generateAdvice() {
  var month = document.getElementById('entryMonth').value;
  var pension = +document.getElementById('entryPension').value || 0;
  var isa = +document.getElementById('entryIsa').value || 0;
  var gia = +document.getElementById('entryGia').value || 0;
  var need = +document.getElementById('entryNeed').value || 2500;

  if (!month) {
    alert('Please select a month');
    return;
  }

  var settings = getSettings();
  var total = pension + isa + gia;

  // Calculate optimal withdrawal for this month's need
  var strategy = calculateOptimalWithdrawal(need, pension, isa, gia, settings, 1);

  var adviceHtml = '<div class="card">' +
    '<h2>This Month\'s Withdrawal Plan</h2>' +
    '<div class="tax-breakdown">' +
    '<h4>Where to take your Â£' + need.toLocaleString() + ' from:</h4>';

  if (strategy.pensionTaxFree > 0) {
    adviceHtml += '<div class="tax-row"><span class="label"><span class="account-badge pension">Pension</span> Tax-free portion</span><span class="amount">' + formatMoneyFull(strategy.pensionTaxFree) + '</span></div>';
  }
  if (strategy.isaWithdraw > 0) {
    adviceHtml += '<div class="tax-row"><span class="label"><span class="account-badge isa">ISA</span> Tax-free</span><span class="amount">' + formatMoneyFull(strategy.isaWithdraw) + '</span></div>';
  }
  if (strategy.giaWithdraw > 0) {
    adviceHtml += '<div class="tax-row"><span class="label"><span class="account-badge gia">GIA</span> Using CGT allowance</span><span class="amount">' + formatMoneyFull(strategy.giaWithdraw) + '</span></div>';
  }
  if (strategy.pensionTaxed > 0) {
    adviceHtml += '<div class="tax-row"><span class="label"><span class="account-badge pension">Pension</span> Taxable (20%)</span><span class="amount">' + formatMoneyFull(strategy.pensionTaxed) + '</span></div>';
  }

  adviceHtml += '<div class="tax-row total"><span class="label">Estimated tax</span><span class="amount">' + formatMoneyFull(strategy.tax) + '</span></div>';
  adviceHtml += '</div>';

  adviceHtml += '<div style="margin-top: 20px;">' +
    '<button onclick="recordWithdrawal(\'' + month + '\', ' + need + ', \'' + formatStrategy(strategy) + '\', ' + total + ')">Record This Withdrawal</button>' +
    '</div></div>';

  document.getElementById('monthlyAdvice').innerHTML = adviceHtml;
  document.getElementById('monthlyAdvice').classList.add('visible');
}

function formatStrategy(strategy) {
  var parts = [];
  if (strategy.pensionTaxFree > 0) parts.push('Pension (TF): Â£' + Math.round(strategy.pensionTaxFree));
  if (strategy.isaWithdraw > 0) parts.push('ISA: Â£' + Math.round(strategy.isaWithdraw));
  if (strategy.giaWithdraw > 0) parts.push('GIA: Â£' + Math.round(strategy.giaWithdraw));
  if (strategy.pensionTaxed > 0) parts.push('Pension (T): Â£' + Math.round(strategy.pensionTaxed));
  return parts.join(', ');
}

function recordWithdrawal(month, amount, source, balance) {
  var history = getHistory();
  history.push({
    month: month,
    amount: amount,
    source: source,
    balance: balance,
    date: new Date().toISOString()
  });
  saveHistory(history);
  renderHistory();
  alert('Withdrawal recorded!');
}

function renderHistory() {
  var history = getHistory();
  var tbody = document.getElementById('historyTable');

  if (history.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No withdrawals recorded yet</td></tr>';
    return;
  }

  tbody.innerHTML = history.slice().reverse().map(function(h) {
    return '<tr>' +
      '<td>' + h.month + '</td>' +
      '<td>Â£' + Math.round(h.amount).toLocaleString() + '</td>' +
      '<td style="font-size: 12px;">' + h.source + '</td>' +
      '<td>' + formatMoney(h.balance) + '</td>' +
      '</tr>';
  }).join('');
}

// ============ SETTINGS ============
function loadSettings() {
  var s = getSettings();
  document.getElementById('settingsPA').value = s.pa;
  document.getElementById('settingsBRL').value = s.brl;
  document.getElementById('settingsCGT').value = s.cgtAllowance || 3000;
  document.getElementById('settingsTaxMode').value = s.taxMode;
}

function saveSettings() {
  var settings = {
    pa: +document.getElementById('settingsPA').value,
    brl: +document.getElementById('settingsBRL').value,
    cgtAllowance: +document.getElementById('settingsCGT').value,
    taxMode: document.getElementById('settingsTaxMode').value
  };
  saveSettingsToStorage(settings);
  alert('Settings saved!');
}

function exportAllData() {
  var data = {
    settings: getSettings(),
    history: getHistory(),
    exportDate: new Date().toISOString(),
    version: '2.1'
  };

  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'pension-planner-backup.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importData(input) {
  if (!input.files || !input.files[0]) return;

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (data.settings) saveSettingsToStorage(data.settings);
      if (data.history) saveHistory(data.history);
      loadSettings();
      renderHistory();
      alert('Data imported successfully!');
    } catch(err) {
      alert('Error importing file: ' + err.message);
    }
  };
  reader.readAsText(input.files[0]);
}

// ============ INITIALIZATION ============
window.addEventListener('DOMContentLoaded', function() {
  // Set current month
  var now = new Date();
  var monthStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  document.getElementById('entryMonth').value = monthStr;

  loadSettings();
  renderHistory();
});
</script>

</body>
</html>
